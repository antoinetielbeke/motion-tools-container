version: '3.8'

services:
  # MariaDB Database
  db:
    image: mariadb:11
    container_name: motion-tools-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-antragsgruen}
      MYSQL_USER: ${DB_USER:-antragsgruen}
      MYSQL_PASSWORD: ${DB_PASSWORD:-antragsgruen}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - motion-tools
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Redis Cache (optional but recommended)
  redis:
    image: redis:7-alpine
    container_name: motion-tools-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - motion-tools
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5

  # PHP-FPM Application
  php-fpm:
    image: ghcr.io/yourusername/motion-tools-php:latest
    # Or build locally:
    # build:
    #   context: ../php-fpm
    #   dockerfile: Dockerfile
    container_name: motion-tools-php
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # PHP Configuration
      PHP_MEMORY_LIMIT: 512M
      PHP_UPLOAD_MAX_FILESIZE: 32M
      PHP_POST_MAX_SIZE: 40M
      PHP_MAX_EXECUTION_TIME: 300
      PHP_TIMEZONE: ${TIMEZONE:-UTC}

      # PHP-FPM Configuration
      PHP_FPM_PM: dynamic
      PHP_FPM_MAX_CHILDREN: 50
      PHP_FPM_START_SERVERS: 5
      PHP_FPM_MIN_SPARE_SERVERS: 5
      PHP_FPM_MAX_SPARE_SERVERS: 35

      # Database Configuration
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-antragsgruen}
      DB_USER: ${DB_USER:-antragsgruen}
      DB_PASSWORD: ${DB_PASSWORD:-antragsgruen}

      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # SMTP Configuration (Symfony Mailer)
      MAILER_DSN: ${MAILER_DSN:-smtp://localhost:1025}
      # Or individual settings:
      # SMTP_HOST: smtp.example.com
      # SMTP_PORT: 587
      # SMTP_USER: noreply@example.com
      # SMTP_PASSWORD: secret
      # SMTP_FROM: noreply@example.com
      # SMTP_AUTH: on
      # SMTP_TLS: on
      # SMTP_STARTTLS: on

      # Application Configuration
      ANTRAGSGRUEN_CONFIG_JSON: |
        {
          "dbConnection": {
            "dsn": "mysql:host=db;dbname=${DB_NAME:-antragsgruen}",
            "username": "${DB_USER:-antragsgruen}",
            "password": "${DB_PASSWORD:-antragsgruen}",
            "charset": "utf8mb4",
            "emulatePrepare": true
          },
          "mailService": {
            "transport": "sendmail"
          },
          "multisiteMode": true,
          "domainPlain": "https://${DOMAIN:-localhost}/",
          "domainSubdomain": "https://<subdomain:[\\w_-]+>.${DOMAIN:-localhost}/",
          "randomSeed": "${RANDOM_SEED:-CHANGE_THIS_TO_RANDOM_VALUE}"
        }

      # Run migrations on startup (optional)
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-false}

    volumes:
      - app_runtime:/var/www/html/runtime
      - app_assets:/var/www/html/web/assets
      - app_config:/var/www/html/config
    networks:
      - motion-tools
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

  # NGINX Web Server
  nginx:
    image: ghcr.io/yourusername/motion-tools-nginx:latest
    # Or build locally:
    # build:
    #   context: ../nginx
    #   dockerfile: Dockerfile
    container_name: motion-tools-nginx
    restart: unless-stopped
    depends_on:
      php-fpm:
        condition: service_healthy
    ports:
      - "${HTTP_PORT:-8080}:80"
      # - "${HTTPS_PORT:-8443}:443"  # Uncomment for HTTPS
    environment:
      # NGINX Configuration
      NGINX_PORT: 80
      NGINX_SERVER_NAME: ${DOMAIN:-_}
      NGINX_WORKER_PROCESSES: auto
      NGINX_WORKER_CONNECTIONS: 2048
      NGINX_CLIENT_MAX_BODY_SIZE: 32M
      NGINX_LOG_LEVEL: warn
      NGINX_LOG_FORMAT: json

      # PHP-FPM Backend
      PHP_FPM_HOST: php-fpm
      PHP_FPM_PORT: 9000

      # Rate Limiting
      NGINX_RATE_LIMIT: 10r/s
      NGINX_RATE_LIMIT_BURST: 20

      # Timeouts
      NGINX_FASTCGI_READ_TIMEOUT: 300s
      NGINX_FASTCGI_SEND_TIMEOUT: 300s

      # OpenTelemetry (optional)
      # OTEL_EXPORTER_ENDPOINT: otel-collector:4317
      # OTEL_SERVICE_NAME: motion-tools-nginx

      # Wait for PHP-FPM (optional)
      WAIT_FOR_PHP_FPM: "true"

    volumes:
      # Share assets with PHP-FPM (read-only for nginx)
      - app_assets:/var/www/html/web/assets:ro
      # Optionally mount custom SSL certificates:
      # - ./ssl:/etc/nginx/ssl:ro
    networks:
      - motion-tools
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # MailHog for testing email (optional, for development)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: motion-tools-mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"  # SMTP
      - "${MAILHOG_WEB_PORT:-8025}:8025"   # Web UI
    networks:
      - motion-tools
    profiles:
      - dev

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  app_runtime:
    driver: local
  app_assets:
    driver: local
  app_config:
    driver: local

networks:
  motion-tools:
    driver: bridge
